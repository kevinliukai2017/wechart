package com.wechart.controller;

import javax.servlet.http.HttpServletRequest;

import org.jeewx.api.core.exception.WexinReqException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;

import com.wechart.model.lottery.LotteryModel;
import com.wechart.model.webaccesstoken.WebAccessTokenModel;
import com.wechart.service.lottery.LotteryService;
import com.wechart.service.webauth.WebAuthService;
import com.wechart.util.LotteryUtil;

@Controller
public class LotteryController {

	private final Logger logger = LoggerFactory.getLogger(this.getClass());
	
	@Autowired
	private LotteryService lotteryService;
	
	@Autowired
	WebAuthService webAuthService;
	
	@RequestMapping("/wx/marketing/lottery")
	public String showLotteryPage(Model model,HttpServletRequest request) throws WexinReqException{
		String code = request.getParameter("code");
		String state = request.getParameter("state");
		logger.info("getWebAccessToken--code: " + code  + ",state: " + state);
		WebAccessTokenModel webAccessToken = webAuthService.getWebAccessToken(code);
		model.addAttribute("webAccessToekn", webAccessToken);
		return "marketing/lottery";
	}
	
	//text/plain;charset=UTF-8
	//application/json;charset=UTF-8
	@RequestMapping(value = "/wx/marketing/lotteryResult" , produces = "text/plain;charset=UTF-8")
	@ResponseBody
	public String lotteryResult(String openid){
		Object result[] = LotteryUtil.award(LotteryUtil.prizeArr);
		
		logger.info("转动角度:"+result[0]+"\t奖项ID:"+result[1]+"\t提示信息:"+result[2]);
		LotteryModel record = new LotteryModel();
		record.setOpenid(openid);
		record.setAwards(result[1].toString());
		record.setDescription(result[2].toString());
		lotteryService.addLotteryRecord(record);
		return "{\"angle\":\""+result[0]+"\",\"msg\":\""+result[2]+"\"}";
	}
	
	@RequestMapping("/marketing/getaward")
	public String getAward() throws WexinReqException{
		return "marketing/awards";
	}
}
